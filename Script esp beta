local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function createBoxESP(player)
    if player == LocalPlayer then return end

    local function applyESP(character)
        -- Đợi HumanoidRootPart (phần trung tâm của nhân vật) xuất hiện
        local rootPart = character:WaitForChild("HumanoidRootPart", 10)
        if not rootPart then return end

        -- Xóa ESP cũ nếu có
        if rootPart:FindFirstChild("BoxESP") then
            rootPart.BoxESP:Destroy()
        end

        -- Tạo BillboardGui để hiển thị trên đầu/xung quanh nhân vật
        local billboard = Instance.new("BillboardGui")
        billboard.Name = "BoxESP"
        billboard.Adornee = rootPart
        billboard.AlwaysOnTop = true
        billboard.Size = UDim2.new(4.5, 0, 6, 0) -- Kích thước khung
        billboard.Parent = rootPart

        -- Tạo khung (Frame)
        local frame = Instance.new("Frame")
        frame.Size = UDim2.new(1, 0, 1, 0)
        frame.BackgroundTransparency = 1 -- Làm trong suốt nền
        frame.BorderSizePixel = 2
        frame.BorderColor3 = Color3.fromRGB(255, 0, 0) -- Màu khung (Đỏ)
        frame.Parent = billboard

        -- Thêm UIStroke để làm viền khung sắc nét hơn
        local stroke = Instance.new("UIStroke")
        stroke.Thickness = 2
        stroke.Color = Color3.fromRGB(255, 0, 0)
        stroke.Parent = frame

        -- Thêm nhãn tên và khoảng cách
        local nameLabel = Instance.new("TextLabel")
        nameLabel.Size = UDim2.new(1, 0, 0.2, 0)
        nameLabel.Position = UDim2.new(0, 0, -0.25, 0) -- Hiện trên đỉnh khung
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
        nameLabel.TextStrokeTransparency = 0
        nameLabel.TextScaled = true
        nameLabel.Parent = frame

        -- Cập nhật khoảng cách liên tục
        spawn(function()
            while character.Parent and rootPart.Parent do
                local distance = (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")) 
                    and (LocalPlayer.Character.HumanoidRootPart.Position - rootPart.Position).Magnitude or 0
                
                nameLabel.Text = player.Name .. " [" .. math.floor(distance) .. "m]"
                task.wait(0.5) -- Cập nhật mỗi 0.5 giây để tiết kiệm hiệu năng
            end
        end)
    end

    player.CharacterAdded:Connect(applyESP)
    if player.Character then
        applyESP(player.Character)
    end
end

-- Áp dụng cho người chơi hiện tại và người mới vào
for _, player in pairs(Players:GetPlayers()) do
    createBoxESP(player)
end
Players.PlayerAdded:Connect(createBoxESP)
