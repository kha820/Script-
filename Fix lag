repeat task.wait() until game:IsLoaded()

local Players = game:GetService("Players")
local Lighting = game:GetService("Lighting")
local player = Players.LocalPlayer
local Workspace = game:GetService("Workspace")

-- Các class effect cần xoá
local BadClasses = {
    "ParticleEmitter",
    "Trail",
    "Beam",
    "Fire",
    "Smoke",
    "Sparkles",
    "Explosion",
    "Highlight",
    "Decal",
    "Texture",
    "SurfaceAppearance",
    "BlurEffect",
    "BloomEffect",
    "SunRaysEffect",
    "ColorCorrectionEffect",
    "DepthOfFieldEffect",
    "Atmosphere",
    "Clouds"
}

local function IsBad(obj)
    for _, c in ipairs(BadClasses) do
        if obj:IsA(c) then
            return true
        end
    end
    return false
end

-- Kiểm tra có phải nhân vật / quái không
local function IsCharacterModel(obj)
    if not obj then return false end
    if obj:IsA("Model") then
        if obj:FindFirstChildOfClass("Humanoid") then
            return true
        end
    end
    return false
end

-- Kiểm tra có nằm trong model nhân vật không
local function IsInsideCharacter(obj)
    local p = obj
    while p do
        if IsCharacterModel(p) then
            return true
        end
        p = p.Parent
    end
    return false
end

-- Hàm xử lý object
local function CleanObject(obj)
    pcall(function()
        -- Nếu là 1 phần của player / NPC / quái → KHÔNG xoá model
        if IsInsideCharacter(obj) then
            -- Chỉ xoá EFFECT gắn trên người
            if IsBad(obj) then
                obj:Destroy()
            end
            return
        end

        -- Nếu là effect → xoá
        if IsBad(obj) then
            obj:Destroy()

        -- Nếu là mesh trang trí
        elseif obj:IsA("SpecialMesh") then
            obj:Destroy()

        -- Nếu là part map
        elseif obj:IsA("MeshPart") or obj:IsA("UnionOperation") or obj:IsA("Part") then
            obj.Material = Enum.Material.Plastic
            obj.Reflectance = 0
            obj.CastShadow = false
        end
    end)
end

-- Dọn toàn map
local function FullClean()
    -- Lighting
    pcall(function()
        Lighting.GlobalShadows = false
        Lighting.FogEnd = 9e9
        Lighting.Brightness = 1
        for _, v in pairs(Lighting:GetChildren()) do
            v:Destroy()
        end
    end)

    -- Workspace
    for _, v in pairs(Workspace:GetDescendants()) do
        CleanObject(v)
    end

    -- Ép quality thấp
    pcall(function()
        settings().Rendering.QualityLevel = 1
    end)

    collectgarbage("collect")
end

-- Chạy lần đầu
FullClean()
print("✅ NO EFFECT MODE (KEEP NPC) ON")

-- Khi respawn
player.CharacterAdded:Connect(function()
    task.wait(1)
    FullClean()
end)

-- Diệt effect realtime (nhưng không xoá quái)
Workspace.DescendantAdded:Connect(function(obj)
    CleanObject(obj)
end)

-- Dọn lại định kỳ
task.spawn(function()
    while true do
        task.wait(6)
        pcall(FullClean)
    end
end)
